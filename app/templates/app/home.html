{% spaceless %}
    {% load static %}
    <!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <title>Ericsson-KPI Dashboard.</title>
        <!-- Preloader -->

        <script>
            window.addEventListener("load", function () {
                setTimeout(function () {
                    document.querySelector('body').classList.add('loaded');
                }, 300);
            });


        </script>
        <!-- Favicon -->
        <link rel="icon" href="{% static 'assets/img/brand/favicon.ico' %}" type="image/png">
        <!-- Page CSS -->
        <link rel="stylesheet" href="{% static 'assets/libs/@fancyapps/fancybox/dist/jquery.fancybox.min.css' %}">
        <link rel="stylesheet" type="text/css" href="{% static 'assets/libs/bootstrap/dist/css/bootstrap.min.css' %}"/>
        <!-- Font Awesome -->
        <link rel="stylesheet" href="{% static 'assets/libs/@fortawesome/fontawesome-free/css/all.min.css' %}">
        <!-- Autocompleted -->
        <link rel="stylesheet" href="{% static 'assets/libs/autocomplete/dist/css/jquery-ui.css' %}">
        <!-- Calendar-->
        <link rel="stylesheet" href="{% static 'assets/libs/flatpickr/dist/flatpickr.min.css' %}">
        <!-- Quick CSS -->
        <link rel="stylesheet" href="{% static 'assets/css/quick-website.css' %}" id="stylesheet">

        <link rel="stylesheet" href="{% static 'assets/libs/sweetalert2/dist/sweetalert2.min.css' %}">

        <!-- Chart Lib -->
        <link href="{% static 'assets/libs/nvd3/nv.d3.min.css' %}" rel="stylesheet" type="text/css">
        <script src="{% static 'assets/libs/nvd3/d3.min.js' %}" charset="utf-8"></script>
        <script src="{% static 'assets/libs/nvd3/nv.d3.min.js' %}"></script>
        <script src="{% static 'assets/libs/nvd3/stream_layers.js' %}"></script>


        <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/gh/Dogfalo/materialize@master/extras/noUiSlider/nouislider.css">
        <link rel="stylesheet"
              href="https://gist.githubusercontent.com/alexventuraio/4d0c725c34941fa42361350dcb43731f/raw/9364364f491288ffa1c1efbe796a44e07c16908d/sponsor.matchxperience.css">
        <!-- Custom Css -->


        <link rel="stylesheet" type="text/css" href="{% static 'assets/libs/datatable/jquery.dataTables.css' %}"/>

        <link rel="stylesheet" href="{% static 'assets/css/custom.css' %}">

    </head>

    <body>
    <!-- Preloader -->
    <div class="preloader">
        <div class="spinner-border text" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <div class="modal fade" tabindex="-1" role="dialog" id="modal-cookies" data-backdrop="true"
         aria-labelledby="modal-cookies" aria-hidden="true">
        <div class="modal-dialog modal-dialog-aside left-4 right-4 bottom-4">
            <div class="modal-content bg-dark-dark">
                <div class="modal-body">
                    <!-- Text -->
                    <p class="text-sm text-white mb-3">
                        Just like many websites, Ericsson uses cookies and related technologies to improve the way our
                        site functions for visitors.
                        It is up to you whether to accept cookies. If you want to opt out (that is, not allow cookies)
                        at any time,
                        all you need to do is update your settings. </p>

                    <!-- Buttons -->
                    <a href="" class="btn btn-sm btn-white" target="_blank">Learn more</a>
                    <button type="button" class="btn btn-sm btn-primary mr-2" data-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <header class="" id="header-main">

        <nav class="navbar navbar-main navbar-expand-lg navbar-light" id="navbar-main">
            {% include "app/basic/navbar.html" %}
        </nav>
    </header>

    <section class="slice py-4" id="formularz-wyceny">
        <div class="container-fluid">
            <div class="row row-grid align-items-center">
                <div class='col-lg-5 col-md-12'>
                    <img src="{% static 'assets/img/brand/ericsonn.png' %}" class='minilogo'/>
                    <span class="title_grand">Ericsson RAN KPI Solution</span>
                </div>
                <div class="col-lg-3 col-md-12">

                </div>

                <div class="col-lg-4 col-md-12">

                    <div class="d-flex" style='width: 100%;flex-direction: row-reverse;'>
                        {% csrf_token %}
                        <div class="form-group d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                       id="flexRadioDefault1" value="daily" checked>
                                <label class="form-check-label" for="flexRadioDefault1">
                                    Daily
                                </label>
                            </div>
                        </div>

                        <div class="form-group d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                       id="flexRadioDefault2" value="weekly">
                                <label class="form-check-label" for="flexRadioDefault2">
                                    Weekly
                                </label>
                            </div>
                        </div>


                        <div class="form-group d-flex align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="flexRadioDefault"
                                       id="flexRadioDefault3" value="monthly">
                                <label class="form-check-label" for="flexRadioDefault3">
                                    Monthly
                                </label>
                            </div>
                        </div>


                    </div>
                </div>


                <div class="col-12 col-md-5 col-lg-4 col-xl-3 order-md-1 pr-md-5 mt-0">

                    <form action="" id="location_frm" method="get">

                        <div class="form-group">
                            {{ form.base_station }}
                        </div>

                        <div class="form-group">
                            {{ form.cell_id }}

                        </div>

                        <div class="form-group">
                            {{ form.kpi }}

                        </div>

                        <div class="form-group">
                            {{ form.date_from }}

                        </div>


                        <div class="form-row">

                            <div class="form-group col-md-12 mb-0">

                                <button class="btn mybtn btn-icon btn-block" type="submit">
                                    <span class="btn-inner--text">APPLY</span>

                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="error">

                    </div>
                </div>
                <div class="col-12 col-md-7 col-lg-8 col-xl-9 order-md-1 mt-0 graph_container">
                    <div id="kpi-chart" class='with-3d-shadow with-transitions' style="width: 100%; height: 50vh; ">
                        <svg></svg>
                    </div>
                    <div class="container-fluid" id="slider-container-1">
                        <div id="slider"></div>
                        <div class="mt-3">
                            <span style="float: left; color: whitesmoke;">min:<span id="min-value">0</span></span>
                            <span style="float: right; color: whitesmoke;">max:<span id="max-value">23</span></span>
                        </div>
                    </div>
                </div>

                <div id="error">

                </div>
            </div>
        </div>
        </div>
    </section>

    <section class="slice" id="slider-container">

    </section>

    <section class="slice">
        <div class="container-fluid" style="overflow-x: auto;">
            <table id="table" class="table table-bordered">
                <thead class="btn-primary">
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Base Station</th>
                    <th>Cell ID</th>
                    <th>NR_SA_SSSR</th>
                    <th>NR_NSA_SSSR</th>
                    <th>NR_SARR</th>
                    <th>NR_NSA_LEG_ARR</th>
                    <th>NR_DLUT</th>
                    <th>NR_LAT_UP_RTT</th>
                    <th>NR_CA</th>
                </tr>
                </thead>
                <tbody>
                {% for data_item in table_data %}
                    <tr>
                        <td>{{ data_item.date }}</td>
                        <td>{{ data_item.time|time:'H:i' }}</td>
                        <td>{{ data_item.base_station }}</td>
                        <td>{{ data_item.cell_id }}</td>
                        <td>{{ data_item.sssr }}</td>
                        <td>{{ data_item.nsa_sssr }}</td>
                        <td>{{ data_item.sarr }}</td>
                        <td>{{ data_item.leg_arr }}</td>
                        <td>{{ data_item.dlut }}</td>
                        <td>{{ data_item.lat_up_rtt }}</td>
                        <td>{{ data_item.ca }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <!-- Core JS  -->
    <script src="{% static 'assets/libs/jquery/dist/jquery.min.js' %}"></script>
    <script src="{% static 'assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/libs/svg-injector/dist/svg-injector.min.js' %}"></script>
    <script src="{% static 'assets/libs/feather-icons/dist/feather.min.js' %}"></script>
    <!-- Optional JS -->
    <script src="{% static 'assets/libs/in-view/dist/in-view.min.js' %}"></script>
    <script src="{% static 'assets/libs/sticky-kit/dist/sticky-kit.min.js' %}"></script>
    <script src="{% static 'assets/libs/imagesloaded/imagesloaded.pkgd.min.js' %}"></script>
    <!-- Page JS -->
    <script src="{% static 'assets/libs/@fancyapps/fancybox/dist/jquery.fancybox.min.js' %}"></script>
    <!-- Autocompleted -->
    <script src="{% static 'assets/libs/autocomplete/dist/js/jquery-ui-1.12.1/jquery-ui.js' %}"></script>
    <!-- Input mask -->
    <script src="{% static 'assets/libs/jquery-mask-plugin/dist/jquery.mask.min.js' %}"></script>
    <!-- Calendar -->
    <script src="{% static 'assets/libs/flatpickr/dist/flatpickr.min.js' %}"></script>
    <!-- Quick JS -->
    <script src="{% static 'assets/js/quick-website.js' %}"></script>
    <script src="{% static 'assets/libs/form/jquery.form.js' %}"></script>


    <script src="{% static 'assets/libs/sweetalert2/dist/sweetalert2.min.js' %}"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Dogfalo/materialize@master/extras/noUiSlider/nouislider.min.js"></script>

    <script src="{% static 'assets/libs/datatable/jquery.dataTables.js' %}"></script>

    <!-- Feather Icons -->
    <script>
        feather.replace({
            'width': '1em',
            'height': '1em'
        })
    </script>
    <script>

        $(document).ready(function () {
            $('#table').DataTable({
                "language": {
                    "search": "_INPUT_"
                }
            });


            $('#table_length select').addClass('form-control form-control-emphasized');
            $("#table_filter > label").addClass('asd');
            var hola = $(".asd").html().slice(7);
            $(".one").addClass("active");
            $(".asd").append("<i class='fas fa-search aff' style='color: #a0aec0; margin-right: 10px;'></i>");
            $('#table_filter input').addClass('form-control mysearch');
            $('#table_filter input').attr("placeholder", "SEARCH. . .");
            $('.paginate_button:not(.current)').attr("style", "color: #d2cdcd !important;");
            $('thead').removeClass('btn-primary');
            $('table').removeClass('table-bordered');
            $('table').addClass('text-light');

            $(".menu_last > li").mouseover(function () {
                $(this).siblings(".iconf").addClass('hovering')
            });
            $(".menu_last > li").mouseout(function () {
                $(this).siblings(".iconf").removeClass('hovering')
            });

            $("#table_filter").append('<div class="m-x-4"><button class="btn two_btn btn-block" onclick="download_csv();" name="valuationButtonSubmit"><span class="btn-inner--text">CSV Export </span></button></div>')
            $(".dataTables_info").addClass('text-light');

        });


        document.addEventListener("DOMContentLoaded", function (event) {
            var slider = document.getElementById('slider');
            noUiSlider.create(slider, {
                start: [0, 23],
                connect: true,
                step: 1,
                range: {
                    'min': 0,
                    'max': 23
                },
                format: {
                    to: (v) => parseFloat(v).toFixed(0),
                    from: (v) => parseFloat(v).toFixed(0)
                },

            });

            slider.noUiSlider.on('change', function (v, handle) {
                $('#min-value').text(v[0]);
                $('#max-value').text(v[1]);
                chart.brushExtent(v);
                chart_obj.transition().duration(500).call(chart);
                nv.utils.windowResize(chart.update);
            });
        });


    </script>
    <script>

        var chart;
        var chart_obj;

        let daily_data = {{ data|safe }};

        let key_name = "{{ kpi_title }}";

        let daily_data_chart = [];
        let daily_data_chart_csv = "data:text/csv;charset=utf-8,";
        let daily_data_chart_csv_weekly = "data:text/csv;charset=utf-8,";
        let daily_data_chart_csv_monthly = "data:text/csv;charset=utf-8,";

        for (let i = 0; i < daily_data.length; i++) {
            daily_data_chart.push({x: daily_data[i].hour, y: daily_data[i].avg})
            daily_data_chart_csv += daily_data[i].hour + ',' + daily_data[i].avg + "\r\n";
        }

        let daily_data_weekly = {{ data_weekly|safe }};
        let daily_data_chart_weekly = [];

        for (let i = 0; i < daily_data_weekly.length; i++) {
            console.log(new Date(daily_data_weekly[i].date).toLocaleDateString());
            daily_data_chart_weekly.push({x: new Date(daily_data_weekly[i].date), y: daily_data_weekly[i].avg});
            daily_data_chart_csv_weekly += new Date(daily_data_weekly[i].date).toLocaleDateString() + ',' + daily_data_weekly[i].avg + "\r\n";
        }

        let daily_data_monthly = {{ data_monthly|safe }};
        let daily_data_chart_monthly = [];

        for (let i = 0; i < daily_data_monthly.length; i++) {
            daily_data_chart_monthly.push({x: new Date(daily_data_monthly[i].week), y: daily_data_monthly[i].avg});
            daily_data_chart_csv_monthly += new Date(daily_data_monthly[i].week).toLocaleDateString() + ',' + daily_data_monthly[i].avg + "\r\n";
        }

        var chart_data = [
            {
                area: false,
                key: key_name,
                values: daily_data_chart,
            },
        ];

        let chart_data_weekly = [
            {
                area: false,
                key: key_name,
                values: daily_data_chart_weekly,
            },
        ];
        let chart_data_monthly = [
            {
                area: false,
                key: key_name,
                values: daily_data_chart_monthly,
            },
        ];


        nv.addGraph(function () {

            chart = nv.models.lineWithFocusChart();

            chart.xAxis.tickFormat(d3.format(',f')).showMaxMin(false);

            chart.x2Axis.tickFormat(d3.format(',f'));

            chart.yAxis.tickFormat(d3.format(',.1f'));

            chart.useInteractiveGuideline(true);

            chart.focusEnable(true);

            chart.forceY(get_minMax_fromData(chart_data));

            chart_obj = d3.select('#kpi-chart svg')
                .datum(chart_data)
                .call(chart);

            nv.utils.windowResize(chart.update);

            return chart;

        });


        setTimeout(function () {
            let v = [0, 23]
            chart.brushExtent(v);
            chart_obj.transition().duration(500).call(chart);
            nv.utils.windowResize(chart.update);
        }, 2000);

        function menu() {
            $(".menu_last").toggle("fast")
        }

        $(document).on('change', '.form-check-input', function () {
            let mode = $('.form-check-input:checked').val();
            update_chart(mode);
        });

        function update_chart(mode) {
            switch (mode) {
                case 'daily':
                    console.log(mode);
                    chart.focusEnable(true);
                    chart.xAxis.tickFormat(d3.format(',f')).showMaxMin(false);
                    chart.forceY(get_minMax_fromData(chart_data));
                    chart_obj.datum(chart_data).transition().duration(500).call(chart);
                    nv.utils.windowResize(chart.update);
                    $('#slider-container').css('visibility', 'visible');
                    break;
                case 'weekly':
                    console.log(mode);
                    chart.focusEnable(false);
                    chart.xAxis.tickFormat(function (d) {
                        return d3.time.format('%x')(new Date(d))
                    }).showMaxMin(false);
                    chart.forceY(get_minMax_fromData(chart_data_weekly));
                    chart_obj.datum(chart_data_weekly).transition().duration(500).call(chart);
                    nv.utils.windowResize(chart.update);
                    $('#slider-container').css('visibility', 'hidden');
                    break;
                case 'monthly':
                    console.log(mode);
                    chart.focusEnable(false);
                    chart.xAxis.tickFormat(function (d) {
                        return d3.time.format('%x')(new Date(d))
                    }).showMaxMin(false);
                    chart.forceY(get_minMax_fromData(chart_data_monthly));
                    chart_obj.datum(chart_data_monthly).transition().duration(500).call(chart);
                    nv.utils.windowResize(chart.update);
                    $('#slider-container').css('visibility', 'hidden');
                    break;
            }
        }

        function download_csv() {
            let mode = $('.form-check-input:checked').val();
            var encodedUri;
            switch (mode) {
                case 'daily':
                    encodedUri = encodeURI(daily_data_chart_csv);
                    break;
                case 'weekly':
                    encodedUri = encodeURI(daily_data_chart_csv_weekly);
                    break;
                case 'monthly':
                    encodedUri = encodeURI(daily_data_chart_csv_monthly);
                    break;
            }
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "my_data.csv");
            document.body.appendChild(link); // Required for FF
            link.click(); // This will download the data file named "my_data.csv".
        }

        $(document).on('change', '#id_base_station', function () {
            var token = '{% csrf_token %}';
            $.ajax({
                headers: {
                    "X-CSRFToken": token
                },
                type: 'post',
                url: "{% url 'app:update_cell' %}",
                data: {
                    'base_station': $(this).val(),
                },
                success: function (data) {
                    if (data.status) {
                        $('#id_cell_id').html('<option value="" selected="">Cell ID</option>');
                        data.data.forEach((item, index) => {
                            console.log(index, item);
                            $('#id_cell_id').append(`<option value="${item}" >${item}</option>`);
                        })
                    }
                }
            });
        });


        function get_minMax_fromData(data) {
            let array = []
            let data_array = data[0].values
            console.log(data);
            for (let i = 0; i < data_array.length; i++) {
                array.push(data_array[i]['y'])
            }

            let max = Math.max(...array);
            let min = Math.min(...array);
            let key = data[0].key;
            let step = 10
            let max_val = 100

            if (key === 'DLUT') {
                step = 200;
                max_val = 20000
            }

            max = Math.ceil(max / step) * step;
            min = Math.floor(min / step) * step;

            min = (min < 0) ? 0 : min;
            max = (max > max_val) ? max_val : max;
            console.log(min, max);
            return [min, max];

        }


    </script>

    </body>

    </html>
{% endspaceless %}